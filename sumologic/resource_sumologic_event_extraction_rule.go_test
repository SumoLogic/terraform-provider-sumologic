package sumologic

import (
	"fmt"
	"testing"

	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/acctest"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/resource"
	"github.com/hashicorp/terraform-plugin-sdk/v2/terraform"
)

func TestAccSumologicEventExtractionRule_crud(t *testing.T) {
	var rule EventExtractionRule
	suffix := acctest.RandString(10)
	name := "terraform_event_rule_" + suffix

	resource.Test(t, resource.TestCase{
		PreCheck:     func() { testAccPreCheck(t) },
		Providers:    testAccProviders,
		CheckDestroy: testAccCheckEventExtractionRuleDestroy(&rule),
		Steps: []resource.TestStep{
			{
				Config: testAccSumologicEventExtractionRule(name),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(
						"sumologic_event_extraction_rule.test",
						"name",
						name,
					),
					resource.TestCheckResourceAttr(
						"sumologic_event_extraction_rule.test",
						"query",
						"_sourceCategory=deployments",
					),
					resource.TestCheckResourceAttr(
						"sumologic_event_extraction_rule.test",
						"enabled",
						"true",
					),
					resource.TestCheckResourceAttr(
						"sumologic_event_extraction_rule.test",
						"configuration.eventType.value_source",
						"Deployment",
					),
					resource.TestCheckResourceAttr(
						"sumologic_event_extraction_rule.test",
						"configuration.eventPriority.value_source",
						"High",
					),
					resource.TestCheckResourceAttr(
						"sumologic_event_extraction_rule.test",
						"configuration.eventSource.value_source",
						"Jenkins",
					),
					resource.TestCheckResourceAttr(
						"sumologic_event_extraction_rule.test",
						"configuration.eventName.value_source",
						"monitor-manager deployed",
					),
				),
			},
			{
				Config: testAccSumologicEventExtractionRuleUpdate(name),
				Check: resource.ComposeTestCheckFunc(
					resource.TestCheckResourceAttr(
						"sumologic_event_extraction_rule.test",
						"description",
						"updated description",
					),
					resource.TestCheckResourceAttr(
						"sumologic_event_extraction_rule.test",
						"enabled",
						"false",
					),
					resource.TestCheckResourceAttr(
						"sumologic_event_extraction_rule.test",
						"configuration.eventDescription.value_source",
						"2 containers upgraded",
					),
				),
			},
			{
				ResourceName:      "sumologic_event_extraction_rule.test",
				ImportState:       true,
				ImportStateVerify: true,
			},
		},
	})
}

func testAccSumologicEventExtractionRule(name string) string {
	return fmt.Sprintf(`
resource "sumologic_event_extraction_rule" "test" {
  name  = "%s"
  query = "_sourceCategory=deployments"

  configuration = {
    eventType = {
      value_source = "Deployment"
    }
    eventPriority = {
      value_source = "High"
    }
    eventSource = {
      value_source = "Jenkins"
    }
    eventName = {
      value_source = "monitor-manager deployed"
    }
  }
}
`, name)
}

func testAccSumologicEventExtractionRuleUpdate(name string) string {
	return fmt.Sprintf(`
resource "sumologic_event_extraction_rule" "test" {
  name        = "%s"
  description = "updated description"
  query       = "_sourceCategory=deployments"
  enabled     = false

  configuration = {
    eventType = {
      value_source = "Deployment"
    }
    eventPriority = {
      value_source = "High"
    }
    eventSource = {
      value_source = "Jenkins"
    }
    eventName = {
      value_source = "monitor-manager deployed"
    }
    eventDescription = {
      value_source = "2 containers upgraded"
    }
  }
}
`, name)
}

func testAccCheckEventExtractionRuleDestroy(rule *EventExtractionRule) resource.TestCheckFunc {
	return func(s *terraform.State) error {
		client := testAccProvider.Meta().(*Client)

		for _, r := range s.RootModule().Resources {
			if r.Type != "sumologic_event_extraction_rule" {
				continue
			}

			found, err := client.GetEventExtractionRule(r.Primary.ID)
			if err != nil {
				return err
			}
			if found != nil {
				return fmt.Errorf("event extraction rule %s still exists", r.Primary.ID)
			}
		}
		return nil
	}
}
